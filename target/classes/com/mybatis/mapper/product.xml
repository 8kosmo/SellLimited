<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper     PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"     "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mybatis.mapper.ProductMapper">
   
   <select id="productList" parameterType="map" resultType="map">
      SELECT * from sale_item
      WHERE mem_id = #{mem_id}
      
   </select>
   <select id="photoList" parameterType="map" resultType="map">
      SELECT photo_name 
        FROM ITEM_PHOTO
      WHERE ITEM_CODE = #{item_code}
   </select>
     <select id="auctionDetail" parameterType="map" resultType="map">
         SELECT BID_TITLE, photo_name, start_price, auct_startdate, auct_enddate, cntBid, fPrice, mem_id, product_detail, buynow_price
      FROM sale_item, item_photo, auct_progress, auction_info,
         (SELECT bid_code, COUNT(r_num) cntBid, MAX(final_price) fPrice FROM bid_log
         GROUP BY bid_code) bid_log
      WHERE sale_item.item_code = item_photo.item_code
      AND auction_info.bid_code = auct_progress.bid_code
      AND auct_progress.bid_code = bid_log.bid_code
      AND AUCTION_INFO.ITEM_CODE = sale_item.item_code
      AND auct_progress.bid_code = #{bid_code}
   </select>
     
    
	<select id="seedDetail" parameterType="map" resultType="map">
   	SELECT bid_title ,start_price ,buynow_price, mem_id ,product_detail ,sale_item.item_code,brand,model_name  
            ,cur_seed, auction_info.bid_code
            ,photo_name 
            ,start_seed,end_seed
        FROM sale_item
           ,(select nvl((select count(bidders_id) from seed),0) cur_seed from dual)
           ,item_photo
           ,auction_info         
      WHERE sale_item.item_code=auction_info.item_code
        AND sale_item.item_code=item_photo.item_code
        AND item_photo.item_code=auction_info.item_code
        AND auction_info.bid_code=#{bid_code}
   </select>
   
   <!--  <select id="seedDetail" parameterType="map" resultType="map">
   SELECT bid_title ,start_price ,buynow_price, mem_id ,product_detail ,sale_item.item_code 
            ,cur_seed, auction_info.bid_code
            ,start_seed,end_seed
        FROM sale_item
           ,(select decode(nvl(count(bidders_id),0),0,0) cur_seed from seed) seed 
           ,auction_info         
      WHERE sale_item.item_code=auction_info.item_code
        AND auction_info.bid_code=#{bid_code}
   </select>   -->
   
   
   <select id="productIns" parameterType="map" statementType="CALLABLE">
      {call proc_AddProd(
                  #{bid_title, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String}
                 ,#{mem_id, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String}
                  ,#{brand , mode=IN, jdbcType=VARCHAR, javaType=java.lang.String}
                  ,#{product_name , mode=IN, jdbcType=VARCHAR, javaType=java.lang.String}
                  ,#{status , mode=IN, jdbcType=VARCHAR, javaType=java.lang.String}
                  ,#{sub_catagory , mode=IN, jdbcType=VARCHAR, javaType=java.lang.String}
                  ,#{modelname, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String}
                  ,#{explanation, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String}
                  ,#{start_price, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String}
                  ,#{auction_period, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String}
                  ,#{buynow_price}
                  ,#{result, mode=OUT, jdbcType=VARCHAR, javaType=java.lang.String}
      )}
   </select>
   
   <update id="fileNameIns" parameterType="list">
      INSERT ALL
         <foreach collection="list" item="item" index="index" separator=" ">
                INTO item_photo(photo_name, item_code) VALUES (#{item.photo_name}, #{item.item_code})
      </foreach>
   SELECT * FROM DUAL
   </update>

   <update id="productUpd" parameterType="map">
      UPDATE SALE_ITEM 
      SET brand       = #{brand}
         ,product_name = #{product_name}
         ,status       = #{status}
         ,admin_ok    = #{admin_ok}
         ,sub_category_code =(SELECT sub_category_code FROM sub_category WHERE sub_category = #{sub_category}) 
         ,modelname     = #{modelname}
         ,explanation    = #{explanation}
         ,attached_file= #{attached_file}
         WHERE item_code = #{item_code}
   </update>
   
   
   <select id="productDel" parameterType="map" statementType="CALLABLE">
    {call proc_ProdDelete(#{item_code, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String}
                      ,#{result, mode=OUT, jdbcType=VARCHAR, javaType=java.lang.String})}
   </select>
<!-- 관리자 승인 이후 트랜잭션 처리 -->
   <update id="managerPermission" parameterType="string">
      UPDATE SALE_ITEM 
            SET status = '시드참여중'
        WHERE item_code = #{item_code}
   </update>
   <!-- AUCTION_INFO 테이블 안에 시드 시작,종료 -->
    <insert id="auction_infoIn" parameterType="string">
      INSERT INTO AUCTION_INFO
      VALUES (#{item_code}
             ,#{item_code}
             ,(SELECT TO_CHAR(SYSDATE, 'yyyy/mm/dd hh24:mi:ss')
                   FROM DUAL)
             ,(SELECT TO_CHAR(SYSDATE + 3, 'yyyy/mm/dd hh24:mi:ss')
                   FROM DUAL)
             )
   </insert>
   <!-- AUCT_PROGRESS 테이블 안에 경매 시작,종료 -->
   <insert id="auct_progressIns" parameterType="map">
      INSERT INTO AUCT_PROGRESS
      VALUES (#{item_code}
             ,(SELECT TO_CHAR(SYSDATE + 3, 'yyyy/mm/dd hh24:mi:ss')
                   FROM DUAL)
             ,(SELECT TO_CHAR(SYSDATE + #{auct_period}/24, 'yyyy/mm/dd hh24:mi:ss')
                   FROM DUAL)
             )
   </insert> 
   <select id="itemStatusList" resultType="map">
      SELECT SALE_ITEM.ITEM_CODE, MEM_ID, SUB_CATEGORY_CODE, PRODUCT_NAME, MODEL_NAME
                   , BUYNOW_PRICE, START_PRICE, AUCT_PERIOD, ITEM_PHOTO.PHOTO_NAME
        FROM SALE_ITEM, (
                            SELECT ITEM_CODE, MAX(PHOTO_NAME) PHOTO_NAME
                              FROM ITEM_PHOTO
                             GROUP BY ITEM_CODE
                          ) ITEM_PHOTO
       WHERE STATUS = '승인대기'
         AND SALE_ITEM.ITEM_CODE = ITEM_PHOTO.ITEM_CODE(+)
       ORDER BY SALE_ITEM.REGISTERTIME DESC
   </select>
   <delete id="managerRefuse" parameterType="string">
      DELETE FROM SALE_ITEM 
       WHERE item_code = #{item_code}
   </delete>
</mapper>