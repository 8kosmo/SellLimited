<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper     PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"     "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mybatis.mapper.ProductMapper">
   
   <select id="photoList" parameterType="map" resultType="map">
      SELECT photo_name 
        FROM ITEM_PHOTO
      WHERE ITEM_CODE = #{item_code}
   </select>
     <select id="auctionDetail" parameterType="map" resultType="map">
         SELECT BID_TITLE, auction_info.bid_code, photo_name, start_price, auct_startdate, auct_enddate, cntBid, fPrice, mem_id, product_detail, buynow_price
      ,sale_item.item_code,brand,model_name
      FROM sale_item, item_photo, auct_progress, auction_info,
         (SELECT bid_code, COUNT(r_num) cntBid, MAX(final_price) fPrice FROM bid_log
         GROUP BY bid_code) bid_log
      WHERE sale_item.item_code = item_photo.item_code
      AND auction_info.bid_code = auct_progress.bid_code
      AND auct_progress.bid_code = bid_log.bid_code
      AND AUCTION_INFO.ITEM_CODE = sale_item.item_code
      AND auct_progress.bid_code = #{bid_code}
   </select>
     
    
	<select id="seedDetail" parameterType="map" resultType="map">
   	SELECT bid_title ,start_price ,buynow_price, mem_id ,product_detail ,sale_item.item_code,brand,model_name  
            ,cur_seed, auction_info.bid_code
            ,photo_name 
            ,start_seed,end_seed
        FROM sale_item
           ,(select nvl((select count(bidders_id) from seed),0) cur_seed from dual)
           ,item_photo
           ,auction_info         
      WHERE sale_item.item_code=auction_info.item_code
        AND sale_item.item_code=item_photo.item_code
        AND item_photo.item_code=auction_info.item_code
        AND auction_info.bid_code=#{bid_code}
   </select>
   
   <select id="productIns" parameterType="map" statementType="CALLABLE">
      {call proc_AddProd(
                  #{bid_title, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String}
                 ,#{mem_id, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String}
                  ,#{brand , mode=IN, jdbcType=VARCHAR, javaType=java.lang.String}
                  ,#{product_name , mode=IN, jdbcType=VARCHAR, javaType=java.lang.String}
                  ,#{status , mode=IN, jdbcType=VARCHAR, javaType=java.lang.String}
                  ,#{sub_catagory , mode=IN, jdbcType=VARCHAR, javaType=java.lang.String}
                  ,#{modelname, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String}
                  ,#{explanation, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String}
                  ,#{start_price, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String}
                  ,#{auction_period, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String}
                  ,#{buynow_price}
                  ,#{result, mode=OUT, jdbcType=VARCHAR, javaType=java.lang.String}
      )}
   </select>
   
   <update id="fileNameIns" parameterType="list">
      INSERT ALL
         <foreach collection="list" item="item" index="index" separator=" ">
                INTO item_photo(photo_name, item_code) VALUES (#{item.photo_name}, #{item.item_code})
      </foreach>
   SELECT * FROM DUAL
   </update>

   <update id="productUpd" parameterType="map">
      UPDATE SALE_ITEM 
      SET brand       = #{brand}
         ,product_name = #{product_name}
         ,status       = #{status}
         ,admin_ok    = #{admin_ok}
         ,sub_category_code =(SELECT sub_category_code FROM sub_category WHERE sub_category = #{sub_category}) 
         ,modelname     = #{modelname}
         ,explanation    = #{explanation}
         ,attached_file= #{attached_file}
         WHERE item_code = #{item_code}
   </update>
   
   
   <select id="productDel" parameterType="map" statementType="CALLABLE">
    {call proc_ProdDelete(#{item_code, mode=IN, jdbcType=VARCHAR, javaType=java.lang.String}
                      ,#{result, mode=OUT, jdbcType=VARCHAR, javaType=java.lang.String})}
   </select>
<!-- 관리자 승인 이후 트랜잭션 처리 -->
   <update id="managerPermission" parameterType="string">
      UPDATE SALE_ITEM 
            SET status = '시드참여중'
        WHERE item_code = #{item_code}
   </update>
   <!-- AUCTION_INFO 테이블 안에 시드 시작,종료 -->
    <insert id="auction_infoIn" parameterType="string">
      INSERT INTO AUCTION_INFO
      VALUES (#{item_code}
             ,#{item_code}
             ,(SELECT TO_CHAR(SYSDATE, 'yyyy/mm/dd/hh24/mi/ss')
                   FROM DUAL)
             ,(SELECT TO_CHAR(SYSDATE + 3, 'yyyy/mm/dd/hh24/mi/ss')
                   FROM DUAL)
             )
   </insert>
   <!-- AUCT_PROGRESS 테이블 안에 경매 시작,종료 -->
   <insert id="auct_progressIns" parameterType="map">
      INSERT INTO AUCT_PROGRESS
      VALUES (#{item_code}
             ,(SELECT TO_CHAR(SYSDATE + 3, 'yyyy/mm/dd/hh24/mi/ss')
                   FROM DUAL)
             ,(SELECT TO_CHAR(SYSDATE + #{auct_period}/24, 'yyyy/mm/dd/hh24/mi/ss')
                   FROM DUAL)
             )
   </insert> 
   <select id="itemStatusList" parameterType="map" resultType="map">
      SELECT ROWNUM, SALE_ITEM.ITEM_CODE, MEM_ID, SUB_CATEGORY_CODE, PRODUCT_NAME
      		, MODEL_NAME, BUYNOW_PRICE, START_PRICE, AUCT_PERIOD, ITEM_PHOTO.PHOTO_NAME
        FROM SALE_ITEM, (
                            SELECT ITEM_CODE, MAX(PHOTO_NAME) PHOTO_NAME
                              FROM ITEM_PHOTO
                             GROUP BY ITEM_CODE
                          ) ITEM_PHOTO
       WHERE STATUS = '승인대기'
         AND SALE_ITEM.ITEM_CODE = ITEM_PHOTO.ITEM_CODE(+)
       <if test="start>0 and end >0">
		 <![CDATA[AND ROWNUM BETWEEN #{start} and #{end}]]>
       </if>
       ORDER BY SALE_ITEM.REGISTERTIME DESC
   </select>
   <delete id="managerRefuse" parameterType="string">
      DELETE FROM SALE_ITEM 
       WHERE item_code = #{item_code}
   </delete>
   <select id="getPermissionTotal" resultType="int" >
        SELECT COUNT(SALE_ITEM.item_code)
          FROM SALE_ITEM,
              (SELECT item_code, MAX(photo_name) FROM ITEM_PHOTO GROUP BY item_code) ITEM_PHOTO
         WHERE SALE_ITEM.item_code = ITEM_PHOTO.item_code(+)
            AND STATUS = '승인대기'
   </select>
   <select id="itemStatusSeedList" parameterType="map" resultType="map">
   SELECT RNO, BID_CODE, ITEM_CODE, STATUS, PRODUCT_DETAIL, BUYNOW_PRICE,
          MEM_ID, PHOTO_NAME, START_SEED, BIDDER_COUNT, END_SEED, BID_COUNT, FINAL_PRICE
     FROM(
	        SELECT RNO, BID_CODE, ITEM_CODE, STATUS, PRODUCT_DETAIL, BUYNOW_PRICE,
	               MEM_ID, PHOTO_NAME, START_SEED, BIDDER_COUNT, END_SEED, BID_COUNT, FINAL_PRICE
	          FROM(
	                SELECT ROWNUM RNO, AUCTION_INFO.BID_CODE,  AUCTION_INFO.ITEM_CODE, SALE_ITEM.STATUS,
	                       SALE_ITEM.PRODUCT_DETAIL, SALE_ITEM.BUYNOW_PRICE,  SALE_ITEM.MEM_ID,
	                       ITEM_PHOTO.PHOTO_NAME, AUCTION_INFO.START_SEED, NVL(SEED.BIDDER_COUNT,'0') BIDDER_COUNT,
	                       TO_DATE(SUBSTR(AUCTION_INFO.END_SEED,0,10),'YYYY/MM/DD')-TO_DATE(TO_CHAR(SYSDATE,'YYYY/MM/DD'))||'일' END_SEED,
	                       NVL(BID_LOG.BID_COUNT,'0') BID_COUNT,  NVL(BID_LOG.FINAL_PRICE,'0') FINAL_PRICE
	                  FROM (SELECT BID_CODE, ITEM_CODE, START_SEED, END_SEED  FROM AUCTION_INFO) AUCTION_INFO,
	                       (SELECT ITEM_CODE, SUB_CATEGORY_CODE, PRODUCT_DETAIL, BUYNOW_PRICE,  MEM_ID, STATUS FROM SALE_ITEM) SALE_ITEM,
	                       (SELECT ITEM_CODE, MAX(PHOTO_NAME) PHOTO_NAME FROM  ITEM_PHOTO GROUP BY ITEM_CODE) ITEM_PHOTO,
	                       (SELECT BID_CODE, AUCT_STARTDATE, AUCT_ENDDATE  FROM AUCT_PROGRESS) AUCT_PROGRESS,
	                       (SELECT BID_CODE, COUNT(FINAL_PRICE) BID_COUNT,  MAX(FINAL_PRICE) FINAL_PRICE FROM BID_LOG GROUP BY  BID_CODE) BID_LOG,
	                       (SELECT BID_CODE, COUNT(BIDDERS_ID) BIDDER_COUNT FROM SEED GROUP BY BID_CODE) SEED
	                WHERE AUCTION_INFO.ITEM_CODE = SALE_ITEM.ITEM_CODE
	                   AND AUCTION_INFO.ITEM_CODE = ITEM_PHOTO.ITEM_CODE(+)
	                   AND AUCTION_INFO.BID_CODE = AUCT_PROGRESS.BID_CODE
	                   AND AUCTION_INFO.BID_CODE = BID_LOG.BID_CODE(+)
	                   AND AUCTION_INFO.BID_CODE = SEED.BID_CODE(+)
				  <if test="sub_category_code != null and sub_category_code.length()>0">
				   	   AND SALE_ITEM.SUB_CATEGORY_CODE = #{sub_category_code}
				  </if>
				  <if test="keyword!=null and keyword.equals('패션')">
					   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0101,0102,0103)
				  </if>
  				  <if test="keyword!=null and keyword.equals('카메라')">
					   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0201,0202,0203)
  				  </if>
  				  <if test="keyword!=null and keyword.equals('악기')">
					   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0301,0302,0303)
  				  </if>
  				  <if test="keyword!=null and keyword.equals('키덜트')">
					   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0401,0402,0403)
  				  </if>
  				  <if test="keyword!=null and keyword.equals('연예인굿즈')">
					   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0501,0502,0503)
  				  </if>
  				  <if test="keyword!=null and keyword.equals('골동품')">
					   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0601,0602,0603)
  				  </if>
  				  <if test="keyword!=null and keyword.equals('게임')">
					   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0701,0702,0703)
  				  </if>
  				  <if test="keyword!=null and keyword.equals('음반')">
					   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0801,0802,0803)
  				  </if>
	                   AND SALE_ITEM.STATUS = '시드참여중'
	                   ORDER BY AUCTION_INFO.END_SEED
	               )
           )
       <if test="start>0 and end >0">
		  <![CDATA[WHERE RNO BETWEEN #{start} AND #{end}]]>
       </if>
   </select>
   <select id="getSeedListTotal" parameterType="map" resultType="int">
        SELECT COUNT(SALE_ITEM.item_code)
          FROM SALE_ITEM,
              (SELECT item_code, MAX(photo_name) FROM ITEM_PHOTO GROUP BY item_code) ITEM_PHOTO
         WHERE SALE_ITEM.item_code = ITEM_PHOTO.item_code(+)
	  <if test="sub_category_code != null and sub_category_code.length()>0">
	   	   AND SALE_ITEM.SUB_CATEGORY_CODE = #{sub_category_code}
	  </if>
	  <if test="keyword!=null and keyword.equals('패션')">
		   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0101,0102,0103)
	  </if>
			  <if test="keyword!=null and keyword.equals('카메라')">
		   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0201,0202,0203)
			  </if>
			  <if test="keyword!=null and keyword.equals('악기')">
		   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0301,0302,0303)
			  </if>
			  <if test="keyword!=null and keyword.equals('키덜트')">
		   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0401,0402,0403)
			  </if>
			  <if test="keyword!=null and keyword.equals('연예인굿즈')">
		   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0501,0502,0503)
			  </if>
			  <if test="keyword!=null and keyword.equals('골동품')">
		   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0601,0602,0603)
			  </if>
			  <if test="keyword!=null and keyword.equals('게임')">
		   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0701,0702,0703)
			  </if>
			  <if test="keyword!=null and keyword.equals('음반')">
		   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0801,0802,0803)
			  </if>
            AND STATUS = '시드참여중'
   </select>
   <select id="itemStatusAuctionList" parameterType="map" resultType="map">
	SELECT RNO, BID_CODE, ITEM_CODE, STATUS, PRODUCT_DETAIL, BUYNOW_PRICE, MEM_ID,
	       PHOTO_NAME, START_SEED, BIDDER_COUNT, AUCT_ENDDATE, BID_COUNT, FINAL_PRICE
	  FROM(
	        SELECT ROWNUM RNO, BID_CODE, ITEM_CODE, STATUS, PRODUCT_DETAIL, BUYNOW_PRICE, MEM_ID,
	               PHOTO_NAME, START_SEED, BIDDER_COUNT, AUCT_ENDDATE, BID_COUNT, FINAL_PRICE
	          FROM(
	                SELECT AUCTION_INFO.BID_CODE,  AUCTION_INFO.ITEM_CODE, SALE_ITEM.STATUS,
	                       SALE_ITEM.PRODUCT_DETAIL, SALE_ITEM.BUYNOW_PRICE,  SALE_ITEM.MEM_ID,
	                       ITEM_PHOTO.PHOTO_NAME, AUCTION_INFO.START_SEED, NVL(SEED.BIDDER_COUNT,'0') BIDDER_COUNT,
	                       TO_DATE(SUBSTR(AUCT_PROGRESS.AUCT_ENDDATE,0,10),'YYYY/MM/DD')-TO_DATE(TO_CHAR(SYSDATE,'YYYY/MM/DD'))||'일' AUCT_ENDDATE,
	                       NVL(BID_LOG.BID_COUNT,'0') BID_COUNT,  BID_LOG.FINAL_PRICE
	                  FROM (SELECT BID_CODE, ITEM_CODE, START_SEED, END_SEED  FROM AUCTION_INFO) AUCTION_INFO,
	                       (SELECT ITEM_CODE, SUB_CATEGORY_CODE, PRODUCT_DETAIL, BUYNOW_PRICE,  MEM_ID, STATUS FROM SALE_ITEM) SALE_ITEM,
	                       (SELECT ITEM_CODE, MAX(PHOTO_NAME) PHOTO_NAME FROM  ITEM_PHOTO GROUP BY ITEM_CODE) ITEM_PHOTO,
	                       (SELECT BID_CODE, AUCT_STARTDATE, AUCT_ENDDATE  FROM AUCT_PROGRESS) AUCT_PROGRESS,
	                       (SELECT BID_CODE, COUNT(FINAL_PRICE) BID_COUNT,  MAX(FINAL_PRICE) FINAL_PRICE FROM BID_LOG GROUP BY  BID_CODE) BID_LOG,
	                       (SELECT BID_CODE, COUNT(BIDDERS_ID) BIDDER_COUNT FROM SEED GROUP BY BID_CODE) SEED
	                WHERE AUCTION_INFO.ITEM_CODE = SALE_ITEM.ITEM_CODE
	                   AND AUCTION_INFO.ITEM_CODE = ITEM_PHOTO.ITEM_CODE(+)
	                   AND AUCTION_INFO.BID_CODE = AUCT_PROGRESS.BID_CODE
	                   AND AUCTION_INFO.BID_CODE = BID_LOG.BID_CODE(+)
	                   AND AUCTION_INFO.BID_CODE = SEED.BID_CODE(+)
				  <if test="sub_category_code != null and sub_category_code.length()>0">
				   	   AND SALE_ITEM.SUB_CATEGORY_CODE = #{sub_category_code}
				  </if>
				  <if test="keyword!=null and keyword.equals('패션')">
					   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0101,0102,0103)
				  </if>
  				  <if test="keyword!=null and keyword.equals('카메라')">
					   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0201,0202,0203)
  				  </if>
  				  <if test="keyword!=null and keyword.equals('악기')">
					   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0301,0302,0303)
  				  </if>
  				  <if test="keyword!=null and keyword.equals('키덜트')">
					   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0401,0402,0403)
  				  </if>
  				  <if test="keyword!=null and keyword.equals('연예인굿즈')">
					   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0501,0502,0503)
  				  </if>
  				  <if test="keyword!=null and keyword.equals('골동품')">
					   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0601,0602,0603)
  				  </if>
  				  <if test="keyword!=null and keyword.equals('게임')">
					   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0701,0702,0703)
  				  </if>
  				  <if test="keyword!=null and keyword.equals('음반')">
					   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0801,0802,0803)
  				  </if>
	                   AND SALE_ITEM.STATUS = '경매진행중'
	                ORDER BY AUCT_PROGRESS.AUCT_ENDDATE
	            )
	      )
       <if test="start>0 and end >0">
		 <![CDATA[WHERE RNO BETWEEN #{start} AND #{end}]]>
       </if>
   </select>
   <select id="getAuctionListTotal" parameterType="map" resultType="int">
        SELECT COUNT(SALE_ITEM.item_code)
          FROM SALE_ITEM,
              (SELECT item_code, MAX(photo_name) FROM ITEM_PHOTO GROUP BY item_code) ITEM_PHOTO
         WHERE SALE_ITEM.item_code = ITEM_PHOTO.item_code(+)
            AND STATUS = '경매진행중'
	  <if test="sub_category_code != null and sub_category_code.length()>0">
	   	   AND SALE_ITEM.SUB_CATEGORY_CODE = #{sub_category_code}
	  </if>
	  <if test="keyword!=null and keyword.equals('패션')">
		   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0101,0102,0103)
	  </if>
			  <if test="keyword!=null and keyword.equals('카메라')">
		   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0201,0202,0203)
			  </if>
			  <if test="keyword!=null and keyword.equals('악기')">
		   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0301,0302,0303)
			  </if>
			  <if test="keyword!=null and keyword.equals('키덜트')">
		   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0401,0402,0403)
			  </if>
			  <if test="keyword!=null and keyword.equals('연예인굿즈')">
		   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0501,0502,0503)
			  </if>
			  <if test="keyword!=null and keyword.equals('골동품')">
		   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0601,0602,0603)
			  </if>
			  <if test="keyword!=null and keyword.equals('게임')">
		   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0701,0702,0703)
			  </if>
			  <if test="keyword!=null and keyword.equals('음반')">
		   AND SALE_ITEM .SUB_CATEGORY_CODE IN (0801,0802,0803)
			  </if>
   </select>
</mapper>